<%- | String $success_color, String $error_color, Hash $validation_data | -%>
# generated by profile/templates/test_dotnet.ps1.epp

# variables passed in via PROFILE_WINDOWSFEATURES
$consoleSuccess     = "<%= $success_color %>"
$consoleError       = "<%= $error_color %>"
$WindowsFeaturesHiera = @{} # empty hash

# Embedded puppet syntax:
# https://docs.puppetlabs.com/puppet/latest/reference/lang_template_epp.html
<% $hiera_features = keys($validation_data)
$hiera_features.each |String $dsc_name| { -%>
$WindowsFeaturesHiera.Add("<%= $dsc_name %>","<%= $validation_data[$dsc_name][dsc_ensure] %>")
<% } -%>

# Determine which features should be Present
$PresentFeatrures = @()
ForEach ($Key in ($WindowsFeaturesHiera.GetEnumerator() | Where-Object {$_.Value -eq "present"}))
{
$PresentFeatrures+=$Key.Name
}

# Determine which features should be Absent
$AbsentFeatrures = @()
ForEach ($Key in ($WindowsFeaturesHiera.GetEnumerator() | Where-Object {$_.Value -ne "present"}))
{
$AbsentFeatrures+=$Key.Name
}

# determine locally installed windowsfeatures
[array]$InstalledFeatures = (Get-WindowsFeature | where {$_.InstallState -eq "Installed"}).Name

# determine locally installed windowsfeatures
[array]$NotInstalledFeatures = (Get-WindowsFeature | where {$_.InstallState -ne "Installed"}).Name


#Confirm features are appropriate state
ForEach($PresentFeatrure in $PresentFeatrures)
{
	if ($InstalledFeatures.Contains($PresentFeatrure))
	{
	  Write-Host "PASS: PROFILE_WINDOWSFEATURES", $PresentFeatrure "Present" -ForegroundColor $consoleSuccess
	}
	else
	{
    Write-Host "FAIL: PROFILE_WINDOWSFEATURES", $PresentFeatrure "not found !!!!!" -ForegroundColor $consoleError
	}
}
ForEach($AbsentFeatrure in $AbsentFeatrures)
{
	if ($NotInstalledFeatures.Contains($AbsentFeatrure))
	{
	  Write-Host "PASS: PROFILE_WINDOWSFEATURES", $AbsentFeatrure "Absent" -ForegroundColor $consoleSuccess
	}
	else
	{
    Write-Host "FAIL: PROFILE_WINDOWSFEATURES", $AbsentFeatrure " should not be installed !!!!!" -ForegroundColor $consoleError
	}
}
